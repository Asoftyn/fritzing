<html xmlns="http://www.w3.org/1999/xhtml" xmlns:tal="http://xml.zope.org/namespaces/tal" xmlns:metal="http://xml.zope.org/namespaces/metal" xmlns:i18n="http://xml.zope.org/namespaces/i18n" xml:lang="en" lang="en" metal:use-macro="context/main_template/macros/master" i18n:domain="fritzing.fab">
  <head>
    <metal:block fill-slot="style_slot" tal:define="navroot context/@@plone_portal_state/navigation_root_url">
      <link rel="stylesheet" type="text/css" tal:attributes="href string:${navroot}/++resource++fritzing.fab/styles.css"/>
    </metal:block>
    <metal:block fill-slot="javascript_head_slot" tal:define="navroot context/@@plone_portal_state/navigation_root_url">
      <script type="text/javascript" tal:attributes="src string:${navroot}/++resource++fritzing.fab/fab.js">
      </script>
    </metal:block>
  </head>
  <body>
    <metal:main fill-slot="main">
      <tal:main-macro metal:define-macro="main" tal:define="navroot context/@@plone_portal_state/navigation_root_url">
            <div>
              <h2>
              <form tal:attributes="action request/URL" method="post">
                      <label for="productionRound">Orders for round</label>
                      <input type="text" size="5" id="productionRound" name="productionRound"
                        tal:attributes="value view/productionRound" autofocus/>
                      <input type="submit" value="Update">
              </form>
              </h2>
              <p>All paid orders from production round 
                <span tal:replace="view/productionRound"/> (current production round is: <span tal:replace="context/currentProductionRound"/>)
              </p>
              <p style="float:left">
                <a tal:attributes="href string:@@currentorders-csv?productionRound=${view/productionRound}">Download as CSV</a> -- 
                <a tal:attributes="href string:@@currentorders-zip?productionRound=${view/productionRound}">Download as ZIP</a> -- 
                <a tal:attributes="href string:@@currentorders?productionRound=${view/productionRound}&updateERP=1">Send to ERP</a> --&nbsp;
                <form tal:attributes="action string:${request/URL}?productionRound=${view/productionRound}" method="post">
                  <label for="workflowAction" style="font-weight: normal">Mark all orders as</label>
                  <select type="select" name="workflowAction" id="workflowAction">
                    <option value=""></option>
                    <option value="produce">in production</option>
                    <option value="complete">shipped</option>
                  </select>
                  <input type="submit" value="Process"/>
                </form>
              </p>
              <table class="orderTable" style="width: 100%; text-align: center; font-size: 80%;">
                <thead>
                  <tr>
                    <th>round</th>
                    <th>date</th>
                    <th>order-id</th>
                    <th>filename</th>
                    <th>count</th>
                    <th>optional</th>
                    <th>boards</th>
                    <th>size</th>
                    <th>price</th>
                    <th>paid</th>
                    <th>checked</th>
                    <th>publishable</th>
                    <th>username</th>
                    <th>address</th>
                    <th>e-mail</th>
                    <th>zone</th>
                    <th>state</th>
                    <th>actions</th>
                  </tr>
                </thead>
                <tbody tal:define="DateTime python:modules['DateTime'].DateTime;
                    wtool here/portal_workflow">
                  <div tal:repeat="brain python:view.getCurrentOrders(context, view.productionRound)" tal:omit-tag="">
                    <div tal:define="order brain/getObject" tal:omit-tag="">
                        <tr tal:repeat="sketch order/listFolderContents">
                          <td tal:content="order/productionRound | string:error">production round</td>
                          <td tal:content="python: DateTime(order.Date()).strftime('%y-%m-%d %H:%M:%S')">date</td>
                          <td><a tal:attributes="href string:${order/absolute_url}" tal:content="order/id | string:error">order-id</a></td>
                          <td>
                                <a tal:define="filename sketch/orderItem/filename;                                              
                                               filename_encoded python:view.encodeFilename(filename);"
                                   tal:content="filename_encoded"
                                   tal:attributes="href string:${sketch/absolute_url}/@@download/orderItem/${filename_encoded};                                                  
                                                   title string:Download ${filename}"/>
                          </td>
                          <td tal:content="sketch/copies">copies</td>
                          <td></td>
                          <td tal:content="python:len(sketch.boards)">boards</td>
                          <td tal:content="python: '%.2f' % (sketch.copies * sketch.area)">size</td>
                          <td tal:content="python: '%.2f' % (sketch.copies * sketch.area * order.pricePerSquareCm + context.checkingFee)">price</td>
                          <td><span tal:replace="order/paymentType | string:error"/> <span tal:replace="order/paymentId | string:error"/></td>
                          <td><span tal:condition="sketch/checked" tal:replace="sketch/checked | string:error"/></td>
                          <td><span tal:condition="sketch/publishable" tal:replace="sketch/publishable | string:error"/></td>
                          <td><a tal:attributes="href string:${portal_url}/author/${order/getOwner}" tal:content="order/getOwner | string:error">owner</a></td>
                          <td>
                            <span tal:replace="order/shippingCompany | nothing"/><br tal:condition="order/shippingCompany | nothing"/>
                            <span tal:replace="order/shippingFirstName | nothing"/> <span tal:replace="order/shippingLastName"/><br/>
                            <span tal:replace="order/shippingStreet | nothing"/><br/>
                            <span tal:replace="order/shippingAdditional | nothing"/><br tal:condition="order/shippingAdditional | nothing"/>
                            <span tal:replace="order/shippingZIP | nothing"/> <span tal:replace="order/shippingCity | nothing"/><br/>
                            <span tal:replace="python: view.getShippingCountry(order.shippingCountry)"/>
                          </td>
                          <td tal:content="order/email | string:error">email</td>
                          <td tal:content="order/shipTo | string:error">zone</td>
                          <td tal:content="python:wtool.getInfoFor(order, 'review_state')">state</td>
                          <td>
                            <a class="viewOrderLink" tal:attributes="href string:${order/absolute_url}">view</a>
                            <a class="viewOrderLink" tal:attributes="href string:${order/absolute_url}/edit">edit</a> 
                          </td>
                        </tr>
                    </div>
                  </div>
                </tbody>
              </table>
            </div>
      </tal:main-macro>
    </metal:main>
  </body>
</html>
